<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Vincent Durmont</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="/assets/css/vdurmont.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/css/prism-hopscotch.css"
    />
  </head>
  <body>
    <div class="page">
      <h1 class="title"><a href="/">Vincent Durmont</a></h1>
      
<p><a href="/">&laquo; Back</a></p>

<p class="blog-date">November 29, 2013</p>
<h1 class="blog-title">First REST API with Node, Express.js, Monk and MongoDB</h1>
<p>One of my <a href="/2013/11/18/first-app-using-express-and-jade.html">previous posts</a> presented how to quickly build a Node-based webapp with a templating system. Today, let's use the same technology stack to build our first REST Web API.</p>
<p>In my job and my personal projects, I alternatively take the positions of frontend and backend developer. In order to separate the responsabilities of each part of the job, the best way is to define an interface. Providing a web API for a service enables us to plug in any frontend display (websites, mobile apps, etc.).</p>
<!--more-->
<h1>Technologies</h1>
<p>Here is a quick presentation of the technologies used in this post, do not hesitate to check them out:</p>
<ul>
<li><a href="http://nodejs.org">Node.js</a> is a platform built on top of Chrome javascript engine which provides a simple way to build javascript apps on the server side.</li>
<li><a href="http://expressjs.com">Express.js</a> is a lightweigth and flexible framework providing an easy way to build node-based web applications.</li>
<li><a href="http://www.mongodb.org/">MongoDB</a> is an open-source document database, the leading NoSQL database. Awesome to store JSON documents in a webapp.</li>
<li><a href="https://github.com/LearnBoost/monk">Monk</a> is a tiny wrapper built on top of <a href="">MongoSkin</a> which provides an abstraction layer to access a MongoDB from Node.</li>
</ul>
<h1>Scenario</h1>
<p>In this post, I will build a simple bug tracker. A bug will be defined as a title, a date of creation, a status and the name of the assignee. Here is an example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span><br>  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Wrong format for the creation date"</span><span class="token punctuation">,</span><br>  <span class="token property">"creation"</span><span class="token operator">:</span> <span class="token string">"2013-11-27T04:33:35Z"</span><span class="token punctuation">,</span><br>  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"OPEN"</span><span class="token punctuation">,</span><br>  <span class="token property">"assignee"</span><span class="token operator">:</span> <span class="token string">"Vincent"</span><br><span class="token punctuation">}</span></code></pre>
<p>We will then be able to create, read, update and delete bugs in the service.</p>
<h1>Set up our express app</h1>
<p>To start with, create a <code>package.json</code> file with the following dependencies and launch <code>npm install</code>.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"MyApp"</span><span class="token punctuation">,</span><br>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span><br>  <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"3.4.4"</span><span class="token punctuation">,</span><br>    <span class="token property">"monk"</span><span class="token operator">:</span> <span class="token string">"0.7.1"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Start a MongoDB database (<a href="http://www.mongodb.org/">download here</a>) with <code>mongod --dbpath /tmp</code>.</p>
<p>We will then create the main file for our webapp. Here are the endpoints which will be accessible:</p>
<ul>
<li><code>GET /bugs</code>: returns the list of the bugs,</li>
<li><code>POST /bugs</code>: creates a bug,</li>
<li><code>GET /bugs/&lt;id&gt;</code>: returns the specified bug,</li>
<li><code>PUT /bugs/&lt;id&gt;</code>: updates and returns the specified bug,</li>
<li><code>DELETE /bugs/&lt;id&gt;</code>: deletes the specified bug</li>
</ul>
<p>In order to keep our <code>app.js</code> file small and clear, we just declare the endpoints and write our business logic in <code>routes.js</code>.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./routes.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>getAll<span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/:id"</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/:id"</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span><br>app<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">"/:id"</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3333</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Running on port 3333!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The file <code>routes.js</code> contains all the business logic. It starts by importing a <code>config.json</code> file which contains the database information and establishes a connexion with the database by using Monk.</p>
<p>Then we execute the requests in the database to store, retrieve or remove the requested data.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span><br>  <span class="token property">"dbname"</span><span class="token operator">:</span> <span class="token string">"example"</span><br><span class="token punctuation">}</span></code></pre>
<p>Â </p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./config.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> monk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"monk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">monk</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>host <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> config<span class="token punctuation">.</span>dbname<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> collection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"bugs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Returns all the bugs</span><br>exports<span class="token punctuation">.</span><span class="token function-variable function">getAll</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bugs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>bugs<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Creates a bug</span><br>exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  collection<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bug</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span> bug<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Get a bug</span><br>exports<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br>  collection<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bug</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bug<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>bug<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Updates a bug</span><br>exports<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br>  <span class="token keyword">var</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  <span class="token keyword">delete</span> body<span class="token punctuation">.</span>_id<span class="token punctuation">;</span><br>  collection<span class="token punctuation">.</span><span class="token function">findAndModify</span><span class="token punctuation">(</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">$set</span><span class="token operator">:</span> body <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token literal-property property">multi</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bug</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bug<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>bug<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">else</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// Deletes a bug</span><br>exports<span class="token punctuation">.</span><span class="token function-variable function">del</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br>  collection<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Simply run <code>npm install &amp;&amp; node app.js</code> and open a browser to <a href="http://localhost:3333">http://localhost:3333</a>. If you see an empty json array (<code>[]</code>), it's okay :)</p>
<p>If you want to test the service, use an HTTP Client (for example, the Google Chrome extension <a href="https://chrome.google.com/webstore/detail/xhr-poster/akdbimilobjkfhgamdhneckaifceicen">XHR Poster</a> is perfect for testing an API).</p>
<h1>Going further</h1>
<p>The API was really easy to set up! But there is a lot of remaining problems like:</p>
<ul>
<li>How to validate our models?</li>
<li>How to handle the authentication?</li>
<li>How to test my API?</li>
<li>Etc.</li>
</ul>
<p><a href="http://github.com/vdurmont/express-monk-mongodb-example" class="btn btn-primary">Download the code of this example</a></p>


    </div>
  </body>
</html>
