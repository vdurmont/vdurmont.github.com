<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Vincent Durmont</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="/assets/css/vdurmont.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/css/prism-hopscotch.css"
    />
  </head>
  <body>
    <div class="page">
      <h1 class="title"><a href="/">Vincent Durmont</a></h1>
      
<p><a href="/">&laquo; Back</a></p>

<p class="blog-date">January 30, 2024</p>
<h1 class="blog-title">GraphQL â€” Use Connections, not Lists</h1>
<p><em>I write a series of posts about GraphQL API design. Find the full list <a href="/posts/2023-03-11-graphql-api-design">here</a>!</em></p>
<h1>TL;DR</h1>
<p>In order to enable proper pagination and give you an opportunity to add metadata, it is strongly recommended to never return lists of items, but Connections.</p>
<p>You can find all of this <a href="https://graphql.org/learn/pagination/">in the official GraphQL docs</a>.</p>
<h1>The longer explanation</h1>
<p>When you are trying to return a set of items, the default intuition is to return a list. However, lists have some limitations that quickly arise when designing your API.</p>
<h2>List of items</h2>
<p>Let's say we have an account and we want to fetch that account's transactions. The first intuition consists in adding a field that returns the list of transactions:</p>
<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Test</span> <span class="token punctuation">{</span><br>  <span class="token object">my_account</span> <span class="token punctuation">{</span><br>    <span class="token object">transactions</span> <span class="token punctuation">{</span><br>      <span class="token property">id</span><br>      <span class="token property">amount</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>When calling the server you'd get a response like this one:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"my_account"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"transactions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span> <span class="token string">"$5"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"456"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span> <span class="token string">"$8"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>      <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"789"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span> <span class="token string">"$3"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>However, pretty quickly, you'll realize that you can't return ALL the transactions. If the account has thousands or millions of them, it'll be a pretty big issue.</p>
<h2>List of items with pagination</h2>
<p>We will quickly introduce a way to only select a subset of the transactions. For example, using the <code>first</code> argument:</p>
<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Test</span> <span class="token punctuation">{</span><br>  <span class="token object">my_account</span> <span class="token punctuation">{</span><br>    <span class="token property-query">transactions</span><span class="token punctuation">(</span><span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token property">id</span><br>      <span class="token property">amount</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2>List of edges</h2>
<p>We'll also want to be able to select which page we want to display. In general, we could indicate what is the offset, or the last ID that we've seen. GraphQL recommends using a cursor-based pagination. Cursors are opaque, and can be either the IDs, or an offset, or any other identifier that the server generates. We can use it with the <code>after</code> argument.</p>
<p>However, cursors are not really part of the items themselves, so GraphQL recommends to wrap each item in an &quot;edge&quot; object that will contain the item itself (usually called <code>node</code>), as well as the <code>cursor</code>.</p>
<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Test</span><span class="token punctuation">(</span><span class="token variable">$last_cursor</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token object">my_account</span> <span class="token punctuation">{</span><br>    <span class="token property-query">transactions</span><span class="token punctuation">(</span><span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token attr-name">after</span><span class="token punctuation">:</span> <span class="token variable">$last_cursor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token property">cursor</span><br>      <span class="token object">node</span> <span class="token punctuation">{</span><br>        <span class="token property">id</span><br>        <span class="token property">amount</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Note that if you have additional information that are not properties of the item or the parent themselves, but rather of their relationship, you can add them to the edge object easily.</p>
<p>An example could be that we'd have an edge between an Auditor and a Transaction that has a status with options &quot;Reviewed&quot; and &quot;Pending Review&quot;. Once the auditor reviews the transaction they could change the status but it wouldn't affect the object itself and other auditors might still have it in their review queues.</p>
<h2>Connections with metadata</h2>
<p>Now, there are some data that you may want to expose that describes the relationship between the parent object and its items but that is not specific to an item. For example, the <code>count</code> of all the items. Or in our example, the <code>amount_received</code>. We can handle this by adding separate fields on the parent object, but it seems much better to add a wrapping object around the list.</p>
<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Test</span><span class="token punctuation">(</span><span class="token variable">$last_cursor</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token object">my_account</span> <span class="token punctuation">{</span><br>    <span class="token property-query">transactions</span><span class="token punctuation">(</span><span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token attr-name">after</span><span class="token punctuation">:</span> <span class="token variable">$last_cursor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token property">count</span><br>      <span class="token property">amount_received</span><br>      <span class="token property">amount_sent</span><br>      <span class="token object">edges</span> <span class="token punctuation">{</span><br>        <span class="token property">cursor</span><br>        <span class="token object">node</span> <span class="token punctuation">{</span><br>          <span class="token property">id</span><br>          <span class="token property">amount</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2>Connections with pagination metadata</h2>
<p>Now that we have a wrapping object, we can actually use it to return a lot of information about the pagination itself. Examples of things that could be useful:</p>
<ul>
<li><code>end_cursor</code>: the cursor of the last edge of this page, to use with the <code>after</code> argument in the next request</li>
<li><code>has_next_page</code>: a boolean that indicates whether there are more items to load</li>
<li>And the pagination could go in the other direction... We could use <code>start_cursor</code> with a <code>before</code> argument, and <code>has_previous_page</code>.</li>
</ul>
<p>All of this can be return in a <code>page_info</code> object:</p>
<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Test</span><span class="token punctuation">(</span><span class="token variable">$last_cursor</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token object">my_account</span> <span class="token punctuation">{</span><br>    <span class="token property-query">transactions</span><span class="token punctuation">(</span><span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token attr-name">after</span><span class="token punctuation">:</span> <span class="token variable">$last_cursor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token property">count</span><br>      <span class="token property">amount_received</span><br>      <span class="token property">amount_sent</span><br>      <span class="token object">edges</span> <span class="token punctuation">{</span><br>        <span class="token property">cursor</span><br>        <span class="token object">node</span> <span class="token punctuation">{</span><br>          <span class="token property">id</span><br>          <span class="token property">amount</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>      <span class="token object">page_info</span> <span class="token punctuation">{</span><br>        <span class="token property">end_cursor</span><br>        <span class="token property">has_next_page</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2>Simplifying things</h2>
<p>While the above example follows the official recommendation, I found that I usually don't have a lot of use for the <code>edge</code> object. While I still leave the option to add this field, I usually end up exposing a <code>nodes</code> field that directly exposes the items in the connection instead of wrapping them. It's just a shortcut and do not prevent you from adding <code>edges</code> if you need them.</p>
<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token definition-query function">Test</span><span class="token punctuation">(</span><span class="token variable">$last_cursor</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token object">my_account</span> <span class="token punctuation">{</span><br>    <span class="token property-query">transactions</span><span class="token punctuation">(</span><span class="token attr-name">first</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token attr-name">after</span><span class="token punctuation">:</span> <span class="token variable">$last_cursor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token property">count</span><br>      <span class="token property">amount_received</span><br>      <span class="token property">amount_sent</span><br>      <span class="token object">nodes</span> <span class="token punctuation">{</span><br>        <span class="token property">id</span><br>        <span class="token property">amount</span><br>      <span class="token punctuation">}</span><br>      <span class="token object">page_info</span> <span class="token punctuation">{</span><br>        <span class="token property">end_cursor</span><br>        <span class="token property">has_next_page</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h1>Counter Examples</h1>
<p>Is there value in exposing basic lists sometimes? Yes. If you are 100% sure that the list of items will be super small (less than 20(?) items, no pagination ever required) and that you won't ever need to expose additional metadata on edges or the connection itself... then you can use a list!</p>
<p>Honestly, I found that those case are pretty rare. In my experience, we expose lists because we're lazy and then we pay the price of having to introduce breaking changes to our API when the list inevitably becomes richer, more complex, and requires more information.</p>
<h1>Further reading</h1>
<p>I recommend to read the <a href="https://graphql.org/learn/pagination/">official GraphQL documentation</a> as well as the <a href="https://relay.dev/graphql/connections.htm">Relay Connection Spec</a> that really define all of this in a much more detailed way.</p>


    </div>
  </body>
</html>
