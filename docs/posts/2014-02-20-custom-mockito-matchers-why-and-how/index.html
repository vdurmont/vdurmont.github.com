<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Vincent Durmont</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="/assets/css/vdurmont.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/css/prism-hopscotch.css"
    />
  </head>
  <body>
    <div class="page">
      <h1 class="title"><a href="/">Vincent Durmont</a></h1>
      
<p><a href="/">&laquo; Back</a></p>

<p class="blog-date">February 20, 2014</p>
<h1 class="blog-title">Custom Mockito matchers</h1>
<p><a href="http://mockito.org">Mockito</a> is an awesome mocking framework that helps you simulate objects and services which have a complex or non-deterministic behavior in your unit tests.</p>
<p>When I check if there are interactions with some of the mocks, I sometimes want to perform custom verifications. In order to do that, let's see how to write custom matchers with Mockito!</p>
<!--more-->
<h1>Basic usage</h1>
<p>Here is a basic example of how to check if a mock is called. We have a service <code>MyService</code> which has a method <code>doStuff()</code> which sends a message.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span><br>	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageService</span> messageService<span class="token punctuation">;</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token class-name">MessageService</span> messageService<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">this</span><span class="token punctuation">.</span>messageService <span class="token operator">=</span> messageService<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token class-name">Human</span> author<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token comment">// TODO do complex stuff</span><br><br>		<span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token keyword">this</span><span class="token punctuation">.</span>messageService<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// TODO do complex stuff again</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span><br>	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Human</span> author<span class="token punctuation">;</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token class-name">Human</span> author<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">this</span><span class="token punctuation">.</span>author <span class="token operator">=</span> author<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">Human</span> <span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> author<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span><br>	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><br>	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Gender</span> gender<span class="token punctuation">;</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">Human</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Gender</span> gender<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><br>		<span class="token keyword">this</span><span class="token punctuation">.</span>gender <span class="token operator">=</span> gender<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> name<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">Gender</span> <span class="token function">getGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> gender<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span><br>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token comment">// TODO send the message :)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>We can write a test that checks that a message is sent when we <code>doStuff()</code>:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">JUnit4</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceTest</span> <span class="token punctuation">{</span><br>	<span class="token annotation punctuation">@Test</span><br>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doStuff_sends_a_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token comment">// GIVEN</span><br>		<span class="token class-name">MessageService</span> mockMessageService <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">MessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token class-name">MyService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span>mockMessageService<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>		<span class="token class-name">Human</span> author <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Human</span><span class="token punctuation">(</span><span class="token string">"Vincent"</span><span class="token punctuation">,</span> <span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// WHEN</span><br>		service<span class="token punctuation">.</span><span class="token function">doStuff</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>		<span class="token comment">// THEN</span><br>		<span class="token function">verify</span><span class="token punctuation">(</span>mockMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>As you can see, Mockito enables us to simulate the <code>MessageService</code> in order to check that it is correctly called. But in this case, we have no way to compare the author of the sent message with our <code>author</code> variable.</p>
<h1>Matcher without argument</h1>
<p>Let's write a custom matcher that will replace the <code>any(Message.class)</code> and check that the author is a male. The test would look like:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><br><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doStuff_sends_a_message_from_a_male</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token comment">// GIVEN</span><br>	<span class="token class-name">MessageService</span> mockMessageService <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">MessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token class-name">MyService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span>mockMessageService<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token class-name">Human</span> author <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Human</span><span class="token punctuation">(</span><span class="token string">"Vincent"</span><span class="token punctuation">,</span> <span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// WHEN</span><br>	service<span class="token punctuation">.</span><span class="token function">doStuff</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// THEN</span><br>	<span class="token function">verify</span><span class="token punctuation">(</span>mockMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">authorIsAMale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Here is the custom matcher:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MaleMatcher</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMatcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span><br>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">authorIsAMale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token function">argThat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MaleMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token annotation punctuation">@Override</span><br>	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Object</span> argument<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token comment">// TODO check null, etc.</span><br>		<span class="token keyword">return</span> <span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">)</span> argument<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h1>Matcher with arguments</h1>
<p>Now let's say we want to compare the beginning of the author's name of the sent message with a String. Here is how it works:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><br><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doStuff_sends_a_message_from_an_author_whose_name_starts_with_V</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token comment">// GIVEN</span><br>	<span class="token class-name">MessageService</span> mockMessageService <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">MessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token class-name">MyService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span>mockMessageService<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token class-name">Human</span> author <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Human</span><span class="token punctuation">(</span><span class="token string">"Vincent"</span><span class="token punctuation">,</span> <span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// WHEN</span><br>	service<span class="token punctuation">.</span><span class="token function">doStuff</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// THEN</span><br>	<span class="token function">verify</span><span class="token punctuation">(</span>mockMessageService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">authorNameStartsWith</span><span class="token punctuation">(</span><span class="token string">"v"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorNameMatcher</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMatcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span><br>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">authorNameStartsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> startsWith<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token function">argThat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorNameMatcher</span><span class="token punctuation">(</span>startsWith<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> expected<span class="token punctuation">;</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">AuthorNameMatcher</span><span class="token punctuation">(</span><span class="token class-name">String</span> expected<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">this</span><span class="token punctuation">.</span>expected <span class="token operator">=</span> expected<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token annotation punctuation">@Override</span><br>	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Object</span> argument<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token comment">// TODO check null, etc.</span><br>		<span class="token class-name">String</span> actual <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">)</span> argument<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token keyword">return</span> actual<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h1>Going further</h1>
<p>Do not forget that you can override the <code>describeTo</code> method in the matchers. It will enable you to display custom error messages!</p>
<p>You can find <a href="https://github.com/vdurmont/custom-mockito-matchers-example">the code on Github</a>.</p>
<p>I hope it will be useful for you!</p>


    </div>
  </body>
</html>
