<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Vincent Durmont</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="/assets/css/vdurmont.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="/assets/css/prism-hopscotch.css"
    />
  </head>
  <body>
    <div class="page">
      <h1 class="title"><a href="/">Vincent Durmont</a></h1>
      
<p><a href="/">&laquo; Back</a></p>

<p class="blog-date">February 22, 2014</p>
<h1 class="blog-title">JSON Mockito matchers</h1>
<p>Yesterday, I wrote about <a href="http://vincent-durmont.com/2014/02/20/custom-mockito-matchers-why-and-how.html">custom Mockito matchers</a> and this article is an example of a real usage of these matchers. In my code, I often use wrapper services that call distant APIs. The service builds a <a href="http://www.json.org/javadoc/org/json/JSONObject.html">JSONObject</a> that will be sent to the server so I need to make sure that it is correct. In order to do that, I need a custom JSON Mockito matcher.</p>
<!--more-->
<p>The class <code>UserService</code> will use the class <code>ApiWrapper</code> in order to create a user on a distant account server. Here is the first test I wrote:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><br><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_user_is_posted_to_distant_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token comment">// GIVEN</span><br>	<span class="token class-name">ApiWrapper</span> apiWrapper <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">ApiWrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span>apiWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"vdurmont@gmail.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Vincent DURMONT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// WHEN</span><br>	userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token comment">// THEN</span><br>	<span class="token class-name">JSONObject</span> json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token function">verify</span><span class="token punctuation">(</span>apiWrapper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>But when I run the test, I got this failure:</p>
<pre class="language-bash"><code class="language-bash">Argument<span class="token punctuation">(</span>s<span class="token punctuation">)</span> are different<span class="token operator">!</span> Wanted:<br>apiWrapper.post<span class="token punctuation">(</span><br>	<span class="token punctuation">{</span><span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"vdurmont@gmail.com"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"Vincent DURMONT"</span><span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br>-<span class="token operator">></span> at com.github.vdurmont.AppTest.test_user_is_posted_to_distant_server<span class="token punctuation">(</span>AppTest.java:34<span class="token punctuation">)</span><br>Actual invocation has different arguments:<br>apiWrapper.post<span class="token punctuation">(</span><br>	<span class="token punctuation">{</span><span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"vdurmont@gmail.com"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"Vincent DURMONT"</span><span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br>-<span class="token operator">></span> at com.github.vdurmont.service.UserService.create<span class="token punctuation">(</span>UserService.java:18<span class="token punctuation">)</span><br><br>/*<br>I got this failure:<br><br>java.lang.AssertionError<br>	at org.junit.Assert.fail<span class="token punctuation">(</span>Assert.java:86<span class="token punctuation">)</span><br>	at org.junit.Assert.assertTrue<span class="token punctuation">(</span>Assert.java:41<span class="token punctuation">)</span><br>	at org.junit.Assert.assertTrue<span class="token punctuation">(</span>Assert.java:52<span class="token punctuation">)</span><br>	at com.github.vdurmont.AppTest.test_json_equals<span class="token punctuation">(</span>AppTest.java:25<span class="token punctuation">)</span><br> */</code></pre>
<p>This is due to the fact that <code>JSONObject</code> doesn't override the method <code>equals</code> so when Mockito uses the default equals matcher, it fails.</p>
<p>In order to have a simple verification, I wrote 2 custom matchers: one for <a href="http://www.json.org/javadoc/org/json/JSONObject.html">JSONObject</a> and one for <a href="http://www.json.org/javadoc/org/json/JSONArray.html">JSONArray</a>.</p>
<p>You can <a href="https://github.com/vdurmont/json-mockito-matchers">find the code on github</a>.</p>


    </div>
  </body>
</html>
